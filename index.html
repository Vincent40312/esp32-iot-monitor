<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 智慧農場 (ThingSpeak Cloud v10.3)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap');
        body { font-family: 'Inter', sans-serif; }
        @keyframes pulse-red { 0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } }
        .animate-pulse-red { animation: pulse-red 2s infinite; }
        /* Date Input Dark Mode Fix */
        input[type="datetime-local"]::-webkit-calendar-picker-indicator { filter: invert(1); cursor: pointer; }
    </style>
</head>
<body class="bg-slate-900 text-slate-200 font-sans min-h-screen flex flex-col">

    <!-- Navbar -->
    <nav class="bg-slate-800 p-4 border-b border-slate-700 sticky top-0 z-50 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center">
                <i class="fa-solid fa-cloud text-blue-400 mr-3 text-xl"></i>
                <h1 class="text-lg md:text-xl font-bold text-white hidden md:block tracking-wide">Smart Farm (TS v10.3)</h1>
                <div class="ml-4 px-2 py-1 text-xs rounded bg-slate-700 text-slate-400 flex items-center transition-all duration-300">
                    <div class="w-2 h-2 rounded-full bg-slate-500 mr-2" id="connDot"></div>
                    <span id="connText">待機</span>
                </div>
            </div>

            <!-- [New] Real-time Clock Display -->
            <div class="hidden md:flex flex-col items-center justify-center mx-4">
                <div id="realTimeClock" class="text-white font-mono font-bold text-lg tracking-wider">00:00:00</div>
                <div id="realTimeDate" class="text-xs text-slate-400">YYYY-MM-DD</div>
            </div>

            <div class="flex items-center gap-3">
                <div class="flex items-center gap-2 bg-slate-900 px-4 py-1.5 rounded-full border border-slate-700 shadow-inner">
                    <i class="fa-solid fa-rotate text-slate-400 text-xs"></i>
                    <span id="nextUpdateTimer" class="font-mono text-blue-400 font-bold tracking-widest text-lg">--</span>
                </div>
                <button onclick="toggleSettings()" class="text-slate-400 hover:text-white p-2 transition hover:rotate-90 duration-300">
                    <i class="fa-solid fa-gear text-lg"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- Settings Modal -->
    <div id="setupPanel" class="fixed inset-0 bg-black/80 z-[60] hidden flex justify-center items-start pt-20 p-4 backdrop-blur-sm">
        <div class="bg-slate-800 p-6 rounded-lg w-full max-w-md border border-blue-500/50 shadow-2xl">
            <h3 class="font-bold mb-4 text-blue-300 text-lg flex items-center"><i class="fa-solid fa-sliders mr-2"></i> ThingSpeak 設定</h3>
            
            <div class="space-y-4">
                <div class="p-3 bg-slate-900/50 rounded border border-slate-700">
                    <h4 class="text-xs font-bold text-slate-400 uppercase mb-2">讀取設定 (監控用)</h4>
                    <div class="mb-2"><label class="block text-xs text-slate-500 mb-1">Channel ID</label><input type="text" id="tsChannel" class="w-full bg-slate-800 border border-slate-600 rounded p-2 focus:border-blue-500 outline-none text-white text-sm" placeholder="例如: 123456"></div>
                    <div class="mb-2"><label class="block text-xs text-slate-500 mb-1">Read API Key (可選)</label><input type="password" id="tsReadKey" class="w-full bg-slate-800 border border-slate-600 rounded p-2 focus:border-blue-500 outline-none text-white text-sm" placeholder="公開頻道可留空"></div>
                    <!-- [New] Results Count Selection -->
                    <div>
                        <label class="block text-xs text-slate-500 mb-1">歷史趨勢讀取筆數</label>
                        <select id="tsResults" class="w-full bg-slate-800 border border-slate-600 rounded p-2 focus:border-blue-500 outline-none text-white text-sm">
                            <option value="10">最近 10 筆</option>
                            <option value="20" selected>最近 20 筆 (預設)</option>
                            <option value="50">最近 50 筆</option>
                            <option value="100">最近 100 筆 (載入較慢)</option>
                        </select>
                    </div>
                </div>

                <div class="p-3 bg-slate-900/50 rounded border border-slate-700">
                    <h4 class="text-xs font-bold text-slate-400 uppercase mb-2">TalkBack 設定 (控制用)</h4>
                    <div class="mb-2"><label class="block text-xs text-slate-500 mb-1">TalkBack ID</label><input type="text" id="tbId" class="w-full bg-slate-800 border border-slate-600 rounded p-2 focus:border-green-500 outline-none text-white text-sm" placeholder="例如: 55962"></div>
                    <div><label class="block text-xs text-slate-500 mb-1">TalkBack API Key</label><input type="password" id="tbKey" class="w-full bg-slate-800 border border-slate-600 rounded p-2 focus:border-green-500 outline-none text-white text-sm" placeholder="例如: T8LJB..."></div>
                </div>
            </div>

            <div class="mt-6 flex gap-3">
                <button onclick="saveAndStart()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded transition shadow-lg">儲存並開始</button>
                <button onclick="toggleSettings()" class="bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded transition">關閉</button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="container mx-auto p-4 max-w-6xl flex-grow">
        <div id="view-dashboard">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                <!-- Monitor & Chart -->
                <div class="lg:col-span-2 flex flex-col gap-6">
                    <div id="monitorCard" class="bg-slate-800 p-6 rounded-xl border border-slate-700 shadow-lg relative overflow-hidden">
                        <!-- BG Effect -->
                        <div class="absolute top-0 right-0 p-4 opacity-5"><i class="fa-solid fa-wifi text-9xl"></i></div>
                        
                        <div class="flex justify-between items-center mb-6 border-b border-slate-700 pb-2 relative z-10">
                            <div class="flex items-center gap-2"><h3 class="text-slate-400 text-sm uppercase font-bold tracking-wider">雲端環境監測</h3><span id="liveBadge" class="px-2 py-0.5 bg-blue-600 text-white text-[10px] rounded font-bold uppercase animate-pulse">Live</span></div>
                            <span class="text-xs text-slate-500 font-mono">Last Data: <span id="lastUpdateTime" class="text-blue-300">--:--:--</span></span>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 relative z-10">
                            <!-- Temp -->
                            <div class="bg-slate-700/30 p-5 rounded-lg text-center border border-transparent transition hover:bg-slate-700/50 group">
                                <i class="fa-solid fa-temperature-half text-3xl text-red-400 mb-3 group-hover:scale-110 transition"></i>
                                <div class="text-5xl font-bold text-white mb-1 tracking-tighter" id="valTemp">--</div>
                                <div class="text-xs text-slate-400 font-bold uppercase">溫度 (Field 1)</div>
                            </div>
                            <!-- Hum -->
                            <div class="bg-slate-700/30 p-5 rounded-lg text-center border border-transparent transition hover:bg-slate-700/50 group">
                                <i class="fa-solid fa-droplet text-3xl text-cyan-400 mb-3 group-hover:scale-110 transition"></i>
                                <div class="text-5xl font-bold text-white mb-1 tracking-tighter" id="valHum">--</div>
                                <div class="text-xs text-slate-400 font-bold uppercase">濕度 (Field 2)</div>
                            </div>
                            <!-- Soil -->
                            <div class="bg-slate-700/30 p-5 rounded-lg text-center border border-transparent transition hover:bg-slate-700/50 group">
                                <i class="fa-solid fa-seedling text-3xl text-green-400 mb-3 group-hover:scale-110 transition"></i>
                                <div class="text-5xl font-bold text-white mb-1 tracking-tighter" id="valSoil">--</div>
                                <div class="text-xs text-slate-400 font-bold uppercase">土壤 (Field 3)</div>
                                <div class="mt-2 text-xs text-slate-500 bg-slate-900/60 rounded-full py-1 px-2 inline-block"><span id="soilStatus" class="text-slate-300 font-bold">--</span></div>
                            </div>
                        </div>
                    </div>

                    <!-- Chart -->
                    <div class="bg-slate-800 p-4 rounded-xl border border-slate-700 h-80 relative shadow-lg">
                        <h3 class="text-slate-400 text-sm uppercase font-bold mb-2 absolute top-4 left-6">歷史趨勢 (Last <span id="chartCountDisplay">20</span> Feeds)</h3>
                        <div class="w-full h-full pb-2 pt-6"><canvas id="historyChart"></canvas></div>
                    </div>
                </div>

                <!-- Right Column: Control & Export -->
                <div class="lg:col-span-1 flex flex-col gap-6">
                    
                    <!-- 1. TalkBack Control -->
                    <div class="bg-slate-800 p-6 rounded-xl border border-slate-700 shadow-lg flex flex-col">
                        <div class="flex justify-between items-center mb-6 border-b border-slate-700 pb-2">
                            <h3 class="text-slate-400 text-sm uppercase font-bold">遠端控制 (TalkBack)</h3>
                            <span class="text-[10px] text-slate-500 bg-slate-900 px-2 py-1 rounded border border-slate-700">Async</span>
                        </div>
                        
                        <div class="space-y-4 flex-grow">
                            <!-- STOP -->
                            <button onclick="sendTalkBack('STOP')" class="w-full bg-red-600 hover:bg-red-700 active:bg-red-800 text-white font-bold py-3 rounded-lg shadow-lg flex items-center justify-center gap-2 transition transform active:scale-95 group border border-red-500">
                                <i class="fa-solid fa-power-off text-xl group-hover:animate-pulse"></i><span class="text-lg">緊急停機 STOP</span>
                            </button>

                            <!-- Auto/Manual -->
                            <div class="bg-slate-900/80 p-4 rounded-lg border border-slate-700 flex flex-col gap-2">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <div id="modeInd" class="w-3 h-3 rounded-full bg-slate-600"></div>
                                        <div class="flex flex-col"><span class="text-sm font-bold text-purple-200">模式設定</span><span class="text-[10px] text-slate-500" id="modeText">讀取中...</span></div>
                                    </div>
                                    <div class="flex gap-1">
                                        <button onclick="sendTalkBack('AUTO_ON')" class="bg-green-600 hover:bg-green-500 active:scale-95 text-white px-3 py-1.5 rounded text-xs font-bold transition">Auto</button>
                                        <button onclick="sendTalkBack('AUTO_OFF')" class="bg-slate-600 hover:bg-slate-500 active:scale-95 text-white px-3 py-1.5 rounded text-xs font-bold transition">Manual</button>
                                    </div>
                                </div>
                            </div>

                            <!-- Pump -->
                            <div class="bg-slate-900/80 p-4 rounded-lg border border-slate-700 flex flex-col gap-2">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <div id="pumpInd" class="w-3 h-3 rounded-full bg-slate-600"></div>
                                        <div class="flex flex-col"><span class="text-sm font-bold text-blue-200">水泵 (Pump)</span><span class="text-[10px] text-slate-500" id="pumpStatusText">--</span></div>
                                    </div>
                                    <div class="flex gap-1">
                                        <button onclick="sendTalkBack('LED1_ON')" class="bg-blue-600 hover:bg-blue-500 active:scale-95 text-white px-3 py-1.5 rounded text-xs font-bold transition">ON</button>
                                        <button onclick="sendTalkBack('LED1_OFF')" class="bg-slate-600 hover:bg-slate-500 active:scale-95 text-white px-3 py-1.5 rounded text-xs font-bold transition">OFF</button>
                                    </div>
                                </div>
                            </div>

                            <!-- Fert -->
                            <div class="bg-slate-900/80 p-4 rounded-lg border border-slate-700 flex flex-col gap-2">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <div id="fertInd" class="w-3 h-3 rounded-full bg-slate-600"></div>
                                        <div class="flex flex-col"><span class="text-sm font-bold text-yellow-200">施肥 (Fert)</span><span class="text-[10px] text-slate-500" id="fertStatusText">--</span></div>
                                    </div>
                                    <div class="flex gap-1">
                                        <button onclick="sendTalkBack('LED2_ON')" class="bg-yellow-600 hover:bg-yellow-500 active:scale-95 text-white px-3 py-1.5 rounded text-xs font-bold transition">ON</button>
                                        <button onclick="sendTalkBack('LED2_OFF')" class="bg-slate-600 hover:bg-slate-500 active:scale-95 text-white px-3 py-1.5 rounded text-xs font-bold transition">OFF</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="cmdStatus" class="text-xs text-center text-slate-500 mt-4 h-4 font-mono tracking-wide">System Ready</div>
                    </div>

                    <!-- 2. Export Data Card (New) -->
                    <div class="bg-slate-800 p-6 rounded-xl border border-slate-700 shadow-lg">
                        <div class="flex justify-between items-center mb-4 border-b border-slate-700 pb-2">
                            <h3 class="text-slate-400 text-sm uppercase font-bold"><i class="fa-solid fa-file-csv mr-2 text-green-500"></i>歷史數據導出</h3>
                        </div>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-[10px] text-slate-500 mb-1 uppercase font-bold">開始時間</label>
                                <input type="datetime-local" id="exportStart" class="w-full bg-slate-900 border border-slate-600 rounded p-2 text-xs text-white focus:border-blue-500 outline-none">
                            </div>
                            <div>
                                <label class="block text-[10px] text-slate-500 mb-1 uppercase font-bold">結束時間</label>
                                <input type="datetime-local" id="exportEnd" class="w-full bg-slate-900 border border-slate-600 rounded p-2 text-xs text-white focus:border-blue-500 outline-none">
                            </div>
                            <button onclick="downloadRangeCSV()" class="w-full bg-slate-700 hover:bg-blue-600 text-white font-bold py-2 rounded text-sm transition flex items-center justify-center gap-2 group">
                                <i class="fa-solid fa-download group-hover:animate-bounce"></i> 下載 CSV
                            </button>
                            <div class="text-[10px] text-slate-500 text-center">* ThingSpeak 單次限制 8000 筆資料</div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
        
        <!-- Logs -->
        <div class="bg-black p-4 rounded-lg border border-slate-700 font-mono text-xs h-32 overflow-y-scroll shadow-inner">
            <div class="text-blue-400 font-bold mb-2 sticky top-0 bg-black/90 p-1 border-b border-blue-900/50 flex justify-between">
                <span>>>> System Log (ThingSpeak API)</span>
                <button onclick="document.getElementById('debugLog').innerHTML=''" class="text-xs text-slate-500 hover:text-white">Clear</button>
            </div>
            <div id="debugLog" class="text-slate-300 space-y-1"></div>
        </div>
    </main>

    <script>
        let timer = null;
        let countdownTimer = null;
        let clockTimer = null; // [New]
        let chart;
        const UPDATE_INTERVAL = 15; // ThingSpeak Free Limit: 15s

        function log(msg, type='info') {
            const box = document.getElementById('debugLog'); if(!box) return;
            const time = new Date().toLocaleTimeString();
            let color = type === 'error' ? "text-red-400" : (type === 'success' ? "text-green-400" : "text-slate-300");
            box.innerHTML += `<div class="${color}">[${time}] ${msg}</div>`;
            box.scrollTop = box.scrollHeight;
        }

        function toggleSettings() { document.getElementById('setupPanel').classList.toggle('hidden'); }

        function saveAndStart() {
            const ch = document.getElementById('tsChannel').value;
            const rk = document.getElementById('tsReadKey').value;
            const results = document.getElementById('tsResults').value; // [New]
            const tid = document.getElementById('tbId').value;
            const tkey = document.getElementById('tbKey').value;

            if(!ch) { alert("請輸入 Channel ID"); return; }

            localStorage.setItem('ts_channel', ch);
            localStorage.setItem('ts_read_key', rk);
            localStorage.setItem('ts_results', results); // [New]
            localStorage.setItem('ts_tb_id', tid);
            localStorage.setItem('ts_tb_key', tkey);

            // Update UI display text
            document.getElementById('chartCountDisplay').innerText = results;

            toggleSettings();
            startPolling();
        }

        function initChart() {
            const ctx = document.getElementById('historyChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        { label: '溫度', borderColor: '#f87171', backgroundColor: 'rgba(248,113,113,0.1)', fill: true, tension: 0.4, data: [], yAxisID: 'y', pointRadius: 3 },
                        { label: '濕度', borderColor: '#22d3ee', backgroundColor: 'rgba(34,211,238,0.1)', fill: true, tension: 0.4, data: [], yAxisID: 'y1', pointRadius: 3 },
                        { label: '土壤', borderColor: '#4ade80', backgroundColor: 'rgba(74,222,128,0.1)', fill: true, tension: 0.4, data: [], yAxisID: 'y1', pointRadius: 3 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, animation: { duration: 0 },
                    plugins: { legend: { labels: { color: '#94a3b8' } } },
                    scales: { 
                        x: { ticks: { color: '#64748b', maxTicksLimit: 6 }, grid: { display: false } }, 
                        y: { 
                            type: 'linear', 
                            display: true, 
                            position: 'left', 
                            ticks: { color: '#f87171', stepSize: 0.1 }, 
                            grid: { color: '#334155' },
                            grace: 0.5
                        },
                        y1: { 
                            type: 'linear', 
                            display: true, 
                            position: 'right', 
                            ticks: { color: '#e2e8f0' }, 
                            grid: { drawOnChartArea: false },
                            suggestedMin: 0,
                            suggestedMax: 100
                        }
                    }
                }
            });
        }

        function startPolling() {
            if(timer) clearInterval(timer);
            if(countdownTimer) clearInterval(countdownTimer);
            fetchData(); // First run
            
            // Polling Loop
            let timeLeft = UPDATE_INTERVAL;
            countdownTimer = setInterval(() => {
                timeLeft--;
                document.getElementById('nextUpdateTimer').innerText = timeLeft + "s";
                if(timeLeft <= 0) timeLeft = UPDATE_INTERVAL;
            }, 1000);

            timer = setInterval(fetchData, UPDATE_INTERVAL * 1000);
        }

        async function fetchData() {
            const ch = localStorage.getItem('ts_channel');
            const rk = localStorage.getItem('ts_read_key');
            const results = localStorage.getItem('ts_results') || 20; // [New] Get count from storage
            if(!ch) return;

            // Fetch feeds with dynamic results count
            const url = `https://api.thingspeak.com/channels/${ch}/feeds.json?api_key=${rk}&results=${results}`;

            updateConnStatus("Fetching...", "text-yellow-400", true);

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error("HTTP " + response.status);
                const data = await response.json();
                
                if(data.feeds && data.feeds.length > 0) {
                    processData(data.feeds);
                    updateConnStatus("Online", "text-green-400", true);
                    log("數據更新成功", "success");
                } else {
                    log("無數據", "error");
                }
            } catch (error) {
                log("Fetch Error: " + error.message, "error");
                updateConnStatus("Error", "text-red-500", false);
            }
        }

        function processData(feeds) {
            const lastFeed = feeds[feeds.length - 1];
            
            // Update Text
            const t = parseFloat(lastFeed.field1);
            const h = parseFloat(lastFeed.field2);
            const s = parseInt(lastFeed.field3);
            const status = parseInt(lastFeed.field4) || 0;

            // Handle -100 Error Code
            updateValue('valTemp', t, '°C');
            updateValue('valHum', h, '%');
            document.getElementById('valSoil').innerText = s;

            // Soil Status Text
            const elSoil = document.getElementById('soilStatus');
            if (s < 20) { elSoil.innerText = "嚴重缺水"; elSoil.className = "text-red-400 font-bold"; }
            else if (s > 80) { elSoil.innerText = "過濕"; elSoil.className = "text-cyan-400 font-bold"; }
            else { elSoil.innerText = "適中"; elSoil.className = "text-green-400 font-bold"; }

            // Last Update Time (from data)
            const date = new Date(lastFeed.created_at);
            document.getElementById('lastUpdateTime').innerText = date.toLocaleTimeString();

            // Status Decoding (Bitmask)
            // Bit 0: Pump, 1: Fert, 2: SoftAlarm, 3: SensorErr, 4: Auto, 5: PumpOL, 6: FertOL
            const isPump = (status & 1) > 0;
            const isFert = (status & 2) > 0;
            const isLock = (status & 4) > 0; // Pump Soft Alarm
            const isErr  = (status & 8) > 0; // Sensor Error
            const isAuto = (status & 16) > 0;
            const isOlPump = (status & 32) > 0; 
            const isOlFert = (status & 64) > 0; 

            // UI Updates based on Status
            updateStatusUI(isAuto, isPump, isFert, isOlPump, isOlFert, isLock, isErr);

            // Chart Update
            if(chart) {
                chart.data.labels = feeds.map(f => new Date(f.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}));
                chart.data.datasets[0].data = feeds.map(f => parseFloat(f.field1) <= -100 ? null : parseFloat(f.field1));
                chart.data.datasets[1].data = feeds.map(f => parseFloat(f.field2) <= -100 ? null : parseFloat(f.field2));
                chart.data.datasets[2].data = feeds.map(f => parseInt(f.field3));
                chart.update();
            }
        }

        function updateValue(id, val, unit) {
            const el = document.getElementById(id);
            if(val <= -100 || isNaN(val)) {
                el.innerText = "Err";
                el.className = "text-5xl font-bold text-red-500 mb-1 tracking-tighter animate-pulse";
            } else {
                el.innerText = val.toFixed(1);
                el.className = "text-5xl font-bold text-white mb-1 tracking-tighter";
            }
        }

        function updateStatusUI(isAuto, isPump, isFert, isOlPump, isOlFert, isLock, isErr) {
            // Mode
            const modeInd = document.getElementById('modeInd');
            const modeText = document.getElementById('modeText');
            if (isAuto) { modeInd.className = "w-3 h-3 rounded-full bg-green-500 shadow-[0_0_10px_#22c55e]"; modeText.innerText = "自動 (Auto)"; modeText.className = "text-[10px] text-green-400 font-bold"; } 
            else { modeInd.className = "w-3 h-3 rounded-full bg-orange-500 shadow-[0_0_10px_#f97316]"; modeText.innerText = "手動 (Manual)"; modeText.className = "text-[10px] text-orange-400 font-bold"; }

            // Pump
            const pumpInd = document.getElementById('pumpInd');
            const pumpTxt = document.getElementById('pumpStatusText');
            if (isOlPump) { pumpInd.className = "w-3 h-3 rounded-full bg-red-600 animate-pulse-red"; pumpTxt.innerText = "過載跳脫 (Trip)"; pumpTxt.className = "text-[10px] text-red-500 font-bold animate-pulse"; }
            else if (isLock) { pumpInd.className = "w-3 h-3 rounded-full bg-red-600 animate-pulse-red"; pumpTxt.innerText = "超時鎖定"; pumpTxt.className = "text-[10px] text-red-500 font-bold"; }
            else if (isPump) { pumpInd.className = "w-3 h-3 rounded-full bg-blue-500 shadow-[0_0_10px_#3b82f6] animate-pulse"; pumpTxt.innerText = "運轉中"; pumpTxt.className = "text-[10px] text-blue-400 font-bold"; }
            else { pumpInd.className = "w-3 h-3 rounded-full bg-slate-600"; pumpTxt.innerText = "待機"; pumpTxt.className = "text-[10px] text-slate-500"; }

            // Fert
            const fertInd = document.getElementById('fertInd');
            const fertTxt = document.getElementById('fertStatusText');
            if (isOlFert) { fertInd.className = "w-3 h-3 rounded-full bg-red-600 animate-pulse-red"; fertTxt.innerText = "過載跳脫 (Trip)"; fertTxt.className = "text-[10px] text-red-500 font-bold animate-pulse"; }
            else if (isFert) { fertInd.className = "w-3 h-3 rounded-full bg-yellow-500 shadow-[0_0_10px_#eab308] animate-pulse"; fertTxt.innerText = "運轉中"; fertTxt.className = "text-[10px] text-yellow-400 font-bold"; }
            else { fertInd.className = "w-3 h-3 rounded-full bg-slate-600"; fertTxt.innerText = "待機"; fertTxt.className = "text-[10px] text-slate-500"; }
        }

        function sendTalkBack(cmd) {
            const tid = localStorage.getItem('ts_tb_id');
            const tkey = localStorage.getItem('ts_tb_key');
            if(!tid || !tkey) { alert("請先設定 TalkBack ID 與 API Key"); toggleSettings(); return; }

            // Show UI feedback
            const statusDiv = document.getElementById('cmdStatus');
            statusDiv.innerText = `發送指令 ${cmd}...`;
            statusDiv.className = "text-xs text-center text-yellow-500 mt-4 h-4 font-mono animate-pulse";

            // ThingSpeak TalkBack requires POST application/x-www-form-urlencoded
            const url = `https://api.thingspeak.com/talkbacks/${tid}/commands.json`;
            const data = new URLSearchParams();
            data.append('api_key', tkey);
            data.append('command_string', cmd);

            fetch(url, {
                method: 'POST',
                body: data
            })
            .then(response => response.json())
            .then(data => {
                log(`指令 ${cmd} 已發送 (ID: ${data.id})`, "success");
                statusDiv.innerText = `指令 ${cmd} 已排程`;
                statusDiv.className = "text-xs text-center text-green-500 mt-4 h-4 font-mono";
            })
            .catch(error => {
                log("指令發送失敗: " + error, "error");
                statusDiv.innerText = `發送失敗`;
                statusDiv.className = "text-xs text-center text-red-500 mt-4 h-4 font-mono";
            });
            
            setTimeout(() => { statusDiv.innerText = "System Ready"; statusDiv.className = "text-xs text-center text-slate-500 mt-4 h-4 font-mono"; }, 3000);
        }

        // [New] Download CSV Function
        function downloadRangeCSV() {
            const ch = localStorage.getItem('ts_channel');
            const rk = localStorage.getItem('ts_read_key');
            
            if(!ch) { alert("請先在設定中輸入 Channel ID"); toggleSettings(); return; }

            const startVal = document.getElementById('exportStart').value;
            const endVal = document.getElementById('exportEnd').value;

            if(!startVal || !endVal) { alert("請選擇開始與結束時間"); return; }

            // Format datetime for ThingSpeak: YYYY-MM-DD%20HH:mm:ss
            // HTML datetime-local input gives: YYYY-MM-DDTHH:mm
            const formatTS = (isoStr) => isoStr.replace('T', '%20') + ':00';
            
            const startStr = formatTS(startVal);
            const endStr = formatTS(endVal);

            let url = `https://api.thingspeak.com/channels/${ch}/feeds.csv?start=${startStr}&end=${endStr}`;
            if(rk) url += `&api_key=${rk}`; // Add key if present (private channel)

            log(`正在下載 CSV (${startVal} ~ ${endVal})...`, "success");
            
            // Trigger download in new window/tab
            window.open(url, '_blank');
        }

        function updateConnStatus(msg, colorClass, isOk) {
            document.getElementById('connText').innerText = msg;
            document.getElementById('connText').className = `text-[10px] font-bold ${colorClass}`;
            document.getElementById('connDot').className = `w-2 h-2 rounded-full ${isOk ? 'bg-green-500 shadow-[0_0_5px_#22c55e]' : 'bg-red-500'}`;
        }

        // [New] Clock Function
        function updateClock() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-GB', { hour12: false }); // 24H format
            const dateStr = now.toLocaleDateString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit' });
            document.getElementById('realTimeClock').innerText = timeStr;
            document.getElementById('realTimeDate').innerText = dateStr;
        }

        window.onload = function() {
            // Start real-time clock
            updateClock();
            clockTimer = setInterval(updateClock, 1000);

            // Set default dates for export inputs (Today)
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const todayStr = `${year}-${month}-${day}`;
            
            document.getElementById('exportStart').value = `${todayStr}T00:00`;
            document.getElementById('exportEnd').value = `${todayStr}T23:59`;

            // Load saved settings
            if(localStorage.getItem('ts_channel')) {
                document.getElementById('tsChannel').value = localStorage.getItem('ts_channel');
                document.getElementById('tsReadKey').value = localStorage.getItem('ts_read_key') || '';
                document.getElementById('tbId').value = localStorage.getItem('ts_tb_id') || '';
                document.getElementById('tbKey').value = localStorage.getItem('ts_tb_key') || '';
                
                // [New] Load Results Count
                const savedResults = localStorage.getItem('ts_results') || '20';
                document.getElementById('tsResults').value = savedResults;
                document.getElementById('chartCountDisplay').innerText = savedResults;

                initChart();
                startPolling();
            } else {
                toggleSettings(); // Open settings on first load
                initChart();
            }
        }
    </script>
</body>
</html>

