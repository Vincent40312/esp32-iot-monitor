<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 æ™ºæ…§è¾²å ´ (Pi Edition v10.3)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap');
        body { font-family: 'Inter', sans-serif; }
        @keyframes pulse-red { 0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } }
        .animate-pulse-red { animation: pulse-red 2s infinite; }
        .data-stale { border-color: #ef4444 !important; background-color: rgba(127, 29, 29, 0.2) !important; }
    </style>
</head>
<body class="bg-slate-900 text-slate-200 font-sans min-h-screen flex flex-col">

    <!-- Security Blocking Modal (HTTPS Warning) -->
    <div id="httpsWarning" class="fixed inset-0 bg-black/90 z-[70] hidden flex flex-col items-center justify-center p-4">
        <div class="bg-slate-800 p-6 rounded-xl border-2 border-red-500 max-w-lg text-center shadow-2xl relative">
            <button onclick="document.getElementById('httpsWarning').classList.add('hidden')" class="absolute top-2 right-2 text-slate-500 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
            <i class="fa-solid fa-shield-halved text-5xl text-red-500 mb-4"></i>
            <h2 class="text-xl font-bold text-white mb-2">æ··åˆå…§å®¹å®‰å…¨æ€§é˜»æ“‹</h2>
            <p class="text-slate-300 text-sm mb-4 text-left">
                æ‚¨æ­£åœ¨ä½¿ç”¨ <b>HTTPS (åŠ å¯†ç¶²é )</b>ï¼Œä½†å˜—è©¦é€£ç·š <b>ws:// (ä¸åŠ å¯†)</b>ã€‚<br>
                ç€è¦½å™¨åŸºæ–¼å®‰å…¨è€ƒé‡é˜»æ“‹äº†æ­¤é€£ç·šã€‚
            </p>
            <div class="bg-black/50 p-3 rounded text-left text-xs font-mono text-yellow-400 mb-6 border border-yellow-900">
                Mixed Content: The page at 'https://...' was loaded over HTTPS, but attempted to connect to the insecure WebSocket endpoint 'ws://...'.
            </div>
            <h3 class="font-bold text-white mb-2">ğŸ‘‡ è§£æ±ºæ–¹æ³• (äºŒé¸ä¸€)ï¼š</h3>
            <ul class="text-left text-sm text-slate-400 mb-6 list-disc pl-5 space-y-2">
                <li><b>æ–¹æ³• Aï¼š</b> åœ¨è¨­å®šä¸­å°‡ Protocol æ”¹ç‚º <b>wss://</b> (éœ€æ¨¹æ¢…æ´¾æ”¯æ´ SSL)ã€‚</li>
                <li><b>æ–¹æ³• Bï¼š</b> ä¸‹è¼‰æ­¤ç¶²é ï¼Œåœ¨é›»è…¦æœ¬æ©Ÿç›´æ¥åŸ·è¡Œ (file://)ã€‚</li>
            </ul>
            <button onclick="downloadSelf()" class="bg-green-600 hover:bg-green-500 text-white font-bold py-3 px-6 rounded-full w-full mb-3 flex items-center justify-center gap-2 shadow-lg">
                <i class="fa-solid fa-download"></i> ä¸‹è¼‰ç¶²é 
            </button>
        </div>
    </div>

    <!-- Navbar (Fixed Wrapping) -->
    <nav class="bg-slate-800 p-3 md:p-4 border-b border-slate-700 sticky top-0 z-50 shadow-lg">
        <div class="container mx-auto flex flex-wrap justify-between items-center gap-y-2">
            <!-- Logo Section -->
            <div class="flex items-center">
                <i class="fa-solid fa-leaf text-green-500 mr-2 md:mr-3 text-xl"></i>
                <h1 class="text-base md:text-xl font-bold text-white tracking-wide">Smart Farm</h1>
                <div class="ml-3 px-2 py-1 text-[10px] md:text-xs rounded bg-slate-700 text-slate-400 flex items-center transition-all duration-300">
                    <div class="w-1.5 h-1.5 md:w-2 md:h-2 rounded-full bg-slate-500 mr-2" id="connDot"></div>
                    <span id="connText">å¾…æ©Ÿ</span>
                </div>
            </div>

            <!-- Clock Section (Responsive) -->
            <div class="flex items-center gap-3 order-3 md:order-2 w-full md:w-auto justify-end md:justify-center border-t border-slate-700 md:border-0 pt-2 md:pt-0">
                <div class="flex flex-col items-end md:items-center">
                    <div id="digitalClock" class="font-mono text-green-400 font-bold tracking-widest text-base md:text-lg leading-none">--:--:--</div>
                    <div id="digitalDate" class="text-[10px] text-slate-500 font-mono mt-0.5">YYYY-MM-DD</div>
                </div>
            </div>

            <!-- Settings Button -->
            <div class="flex gap-2 items-center order-2 md:order-3">
                <button onclick="toggleSettings()" class="text-slate-400 hover:text-white p-2 transition hover:rotate-90 duration-300">
                    <i class="fa-solid fa-gear text-lg"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- Settings Modal -->
    <div id="setupPanel" class="fixed inset-0 bg-black/80 z-[60] hidden flex justify-center items-start pt-20 p-4 backdrop-blur-sm">
        <div class="bg-slate-800 p-6 rounded-lg w-full max-w-md border border-green-500/50 shadow-2xl">
            <h3 class="font-bold mb-4 text-green-300 text-lg flex items-center"><i class="fa-solid fa-sliders mr-2"></i> MQTT è¨­å®š</h3>
            
            <div class="space-y-4">
                <!-- Host -->
                <div><label class="block text-xs text-slate-400 mb-1 font-bold">Host (Broker IP)</label><input type="text" id="mqttHost" class="w-full bg-slate-900 border border-slate-600 rounded p-2 focus:border-green-500 outline-none transition text-white" value="mqtt.40312168.xyz"></div>
                
                <!-- Protocol -->
                <div>
                    <label class="block text-xs text-slate-400 mb-1 font-bold">Protocol (å”å®š)</label>
                    <select id="mqttProto" onchange="autoSetPort()" class="w-full bg-slate-900 border border-slate-600 rounded p-2 focus:border-green-500 outline-none text-white text-sm">
                        <option value="wss">wss:// (åŠ å¯† - Port 443 æ¨è–¦)</option>
                        <option value="ws">ws:// (ä¸åŠ å¯† - Port 9001)</option>
                    </select>
                </div>

                <!-- Port & Path -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs text-slate-400 mb-1 font-bold">Port</label>
                        <input type="number" id="mqttPort" class="w-full bg-slate-900 border border-slate-600 rounded p-2 focus:border-green-500 outline-none text-white" value="443">
                    </div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1 font-bold">Path (è·¯å¾‘)</label>
                        <div class="flex relative">
                            <input type="text" id="mqttPath" class="w-full bg-slate-900 border border-slate-600 rounded p-2 focus:border-green-500 outline-none text-white" value="/mqtt">
                            <select onchange="document.getElementById('mqttPath').value = this.value" class="absolute right-0 top-0 bottom-0 w-6 opacity-0 cursor-pointer">
                                <option value="/mqtt">/mqtt</option>
                                <option value="/ws">/ws</option>
                            </select>
                            <div class="absolute right-2 top-2 text-slate-500 pointer-events-none text-xs"><i class="fa-solid fa-caret-down"></i></div>
                        </div>
                    </div>
                </div>

                <!-- Chart Buffer Size -->
                <div>
                    <label class="block text-xs text-slate-400 mb-1 font-bold">åœ–è¡¨é¡¯ç¤ºç­†æ•¸ (Buffer Size)</label>
                    <select id="chartLimit" class="w-full bg-slate-900 border border-slate-600 rounded p-2 focus:border-green-500 outline-none text-white text-sm">
                        <option value="30">æœ€è¿‘ 30 ç­† (é è¨­)</option>
                        <option value="60">æœ€è¿‘ 60 ç­†</option>
                        <option value="120">æœ€è¿‘ 120 ç­†</option>
                        <option value="300">æœ€è¿‘ 300 ç­† (è¼ƒè€—æ•ˆèƒ½)</option>
                    </select>
                </div>

                <!-- User & Pass -->
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-xs text-slate-400 mb-1 font-bold">User <span class="text-red-400">(å¿…å¡«)</span></label><input type="text" id="mqttUser" class="w-full bg-slate-900 border border-slate-600 rounded p-2 text-sm focus:border-green-500 outline-none text-white" placeholder="è«‹è¼¸å…¥å¸³è™Ÿ"></div>
                    <div><label class="block text-xs text-slate-400 mb-1 font-bold">Pass <span class="text-red-400">(å¿…å¡«)</span></label><input type="password" id="mqttPass" class="w-full bg-slate-900 border border-slate-600 rounded p-2 text-sm focus:border-green-500 outline-none text-white" placeholder="è«‹è¼¸å…¥å¯†ç¢¼"></div>
                </div>
            </div>

            <div class="mt-6 flex gap-3">
                <button onclick="saveAndConnect()" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded transition shadow-lg">å„²å­˜ä¸¦é€£ç·š</button>
                <button onclick="toggleSettings()" class="bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded transition">é—œé–‰</button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="container mx-auto p-4 max-w-6xl flex-grow">
        <div id="view-dashboard">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                <!-- Monitor & Chart -->
                <div class="lg:col-span-2 flex flex-col gap-6">
                    <div id="monitorCard" class="bg-slate-800 p-6 rounded-xl border border-slate-700 shadow-lg transition-colors duration-500">
                        <div class="flex justify-between items-center mb-6 border-b border-slate-700 pb-2">
                            <div class="flex items-center gap-2"><h3 class="text-slate-400 text-sm uppercase font-bold tracking-wider">ç’°å¢ƒå³æ™‚ç›£æ¸¬ (MQTT)</h3><span id="staleBadge" class="hidden px-2 py-0.5 bg-red-600 text-white text-[10px] rounded font-bold uppercase animate-pulse">Offline</span></div>
                            <span class="text-xs text-slate-500 font-mono">æ›´æ–°: <span id="lastUpdate" class="text-white">--</span></span>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <!-- Temp -->
                            <div class="bg-slate-700/30 p-5 rounded-lg text-center border border-transparent transition-all duration-500 hover:bg-slate-700/50">
                                <i class="fa-solid fa-temperature-half text-3xl text-red-400 mb-3"></i>
                                <div class="text-4xl lg:text-5xl font-bold text-white mb-1 tracking-tighter" id="valTemp">--</div>
                                <div class="text-xs text-slate-400 font-bold uppercase">æº«åº¦ Â°C</div>
                            </div>
                            <!-- Hum -->
                            <div class="bg-slate-700/30 p-5 rounded-lg text-center border border-transparent transition-all duration-500 hover:bg-slate-700/50">
                                <i class="fa-solid fa-droplet text-3xl text-cyan-400 mb-3"></i>
                                <div class="text-4xl lg:text-5xl font-bold text-white mb-1 tracking-tighter" id="valHum">--</div>
                                <div class="text-xs text-slate-400 font-bold uppercase">æ¿•åº¦ %</div>
                            </div>
                            <!-- Soil -->
                            <div class="bg-slate-700/30 p-5 rounded-lg text-center border border-transparent transition-all duration-500 hover:bg-slate-700/50">
                                <i class="fa-solid fa-seedling text-3xl text-green-400 mb-3"></i>
                                <div class="text-4xl lg:text-5xl font-bold text-white mb-1 tracking-tighter" id="valSoil">--</div>
                                <div class="text-xs text-slate-400 font-bold uppercase">åœŸå£¤ %</div>
                                <div class="mt-2 text-xs text-slate-500 bg-slate-900/60 rounded-full py-1 px-2 inline-block">ç‹€æ…‹: <span id="soilStatus" class="text-slate-300 font-bold">--</span></div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-slate-800 p-4 rounded-xl border border-slate-700 h-80 relative shadow-lg">
                        <h3 class="text-slate-400 text-sm uppercase font-bold mb-2 absolute top-4 left-6">è¶¨å‹¢åˆ†æ (å³æ™‚, Max <span id="chartLimitDisplay">30</span> ç­†)</h3>
                        <div class="w-full h-full pb-2 pt-6"><canvas id="liveChart"></canvas></div>
                    </div>
                </div>

                <!-- Control Panel -->
                <div class="lg:col-span-1">
                    <div class="bg-slate-800 p-6 rounded-xl border border-slate-700 shadow-lg flex flex-col h-full">
                        <h3 class="text-slate-400 text-sm uppercase font-bold mb-6 border-b border-slate-700 pb-2">è‡ªå‹•åŒ–é‹ä½œç‹€æ…‹</h3>
                        <div class="space-y-4 flex-grow">
                            <button onclick="publishCmd('STOP')" class="w-full bg-red-600 hover:bg-red-700 active:bg-red-800 text-white font-bold py-3 rounded-lg shadow-lg flex items-center justify-center gap-2 transition transform active:scale-95 group border border-red-500"><i class="fa-solid fa-power-off text-xl group-hover:animate-pulse"></i><span class="text-lg">ç·Šæ€¥åœæ©Ÿ STOP</span></button>
                            
                            <!-- Mode -->
                            <div class="bg-slate-900/80 p-4 rounded-lg border border-slate-700 flex flex-col gap-2 transition hover:border-purple-500/50">
                                <div class="flex flex-wrap items-center justify-between gap-2">
                                    <div class="flex items-center gap-3">
                                        <div id="modeInd" class="w-3 h-3 rounded-full bg-slate-600"></div>
                                        <div class="flex flex-col"><span class="text-sm font-bold text-purple-200">é‹ä½œæ¨¡å¼</span><span class="text-[10px] text-slate-500" id="modeText">--</span></div>
                                    </div>
                                    <div class="flex gap-1">
                                        <button onclick="publishCmd('AUTO_ON')" class="bg-green-600 hover:bg-green-500 active:scale-95 text-white px-2 py-1.5 rounded text-xs font-bold transition shadow">Auto</button>
                                        <button onclick="publishCmd('AUTO_OFF')" class="bg-slate-600 hover:bg-slate-500 active:scale-95 text-white px-2 py-1.5 rounded text-xs font-bold transition shadow">Manual</button>
                                    </div>
                                </div>
                            </div>

                            <!-- Sensor Status -->
                            <div class="bg-slate-900/50 p-3 rounded-lg border border-slate-700 flex items-center justify-between"><div class="flex items-center gap-3"><i id="sensorIcon" class="fa-solid fa-heart-pulse text-slate-500 text-lg"></i><span class="text-sm font-bold text-slate-300">æ„Ÿæ¸¬å™¨å¥åº·åº¦</span></div><span id="sensorText" class="text-xs font-bold text-green-500 bg-green-500/10 px-2 py-1 rounded">OK</span></div>
                            
                            <!-- Pump -->
                            <div class="bg-slate-900/80 p-4 rounded-lg border border-slate-700 flex flex-col gap-2 transition hover:border-blue-500/50">
                                <div class="flex flex-wrap items-center justify-between gap-2">
                                    <div class="flex items-center gap-3">
                                        <div id="pumpInd" class="w-3 h-3 rounded-full bg-slate-600"></div>
                                        <div class="flex flex-col"><span class="text-sm font-bold text-blue-200">æ°´æ³µ (Pump)</span><span class="text-[10px] text-slate-500" id="pumpStatusText">Idle</span></div>
                                    </div>
                                    <div class="flex gap-1">
                                        <button onclick="publishCmd('LED1_ON')" class="bg-blue-600 hover:bg-blue-500 active:scale-95 text-white px-3 py-1.5 rounded text-xs font-bold transition shadow">ON</button>
                                        <button onclick="publishCmd('LED1_OFF')" class="bg-slate-600 hover:bg-slate-500 active:scale-95 text-white px-3 py-1.5 rounded text-xs font-bold transition shadow">OFF</button>
                                    </div>
                                </div>
                            </div>

                            <!-- Fert -->
                            <div class="bg-slate-900/80 p-4 rounded-lg border border-slate-700 flex flex-col gap-2 transition hover:border-yellow-500/50">
                                <div class="flex flex-wrap items-center justify-between gap-2">
                                    <div class="flex items-center gap-3">
                                        <div id="fertInd" class="w-3 h-3 rounded-full bg-slate-600"></div>
                                        <div class="flex flex-col"><span class="text-sm font-bold text-yellow-200">æ–½è‚¥ (Fert)</span><span class="text-[10px] text-slate-500" id="fertStatusText">Idle</span></div>
                                    </div>
                                    <div class="flex gap-1">
                                        <button onclick="publishCmd('LED2_ON')" class="bg-yellow-600 hover:bg-yellow-500 active:scale-95 text-white px-3 py-1.5 rounded text-xs font-bold transition shadow">ON</button>
                                        <button onclick="publishCmd('LED2_OFF')" class="bg-slate-600 hover:bg-slate-500 active:scale-95 text-white px-3 py-1.5 rounded text-xs font-bold transition shadow">OFF</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="cmdStatus" class="text-xs text-center text-slate-500 mt-4 h-4 font-mono tracking-wide">System Ready</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Log -->
        <div class="bg-black p-4 rounded-lg border border-slate-700 font-mono text-xs h-32 overflow-y-scroll shadow-inner relative">
            <div class="text-green-400 font-bold mb-2 sticky top-0 bg-black/90 p-1 border-b border-green-900/50 flex justify-between">
                <span>>>> MQTT System Log</span>
                <button onclick="document.getElementById('debugLog').innerHTML=''" class="text-xs text-slate-500 hover:text-white">Clear</button>
            </div>
            <div id="debugLog" class="text-slate-300 space-y-1"></div>
        </div>
    </main>

    <footer class="text-center p-4 text-slate-600 text-xs border-t border-slate-800 mt-4">ESP32 Smart Farm (Pi Edition) &copy; 2025 æœ¬ç³»çµ±ç”±å”è²«ç€šç¨ç«‹è£½ä½œ</footer>

    <script>
        let client = null, mqttConnected = false, chart;
        const topicSub = "farm/monitor";
        const topicPub = "farm/control";

        function log(msg, type='info') {
            const box = document.getElementById('debugLog'); if(!box) return;
            const time = new Date().toLocaleTimeString();
            let color = type === 'error' ? "text-red-400" : (type === 'success' ? "text-green-400" : "text-slate-300");
            box.innerHTML += `<div class="${color}">[${time}] ${msg}</div>`;
            box.scrollTop = box.scrollHeight;
        }

        function toggleSettings() { document.getElementById('setupPanel').classList.toggle('hidden'); }

        // [New] Auto switch port based on protocol selection
        function autoSetPort() {
            const proto = document.getElementById('mqttProto').value;
            const portInput = document.getElementById('mqttPort');
            if (!portInput) return; // Safety check
            if (proto === 'wss') {
                portInput.value = 443; 
            } else {
                portInput.value = 9001;
            }
        }

        function downloadSelf() {
            const htmlContent = document.documentElement.outerHTML;
            const blob = new Blob([htmlContent], { type: "text/html" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "index.html";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function initChart() {
            const ctx = document.getElementById('liveChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        { label: 'æº«åº¦', borderColor: '#f87171', backgroundColor: 'rgba(248,113,113,0.1)', fill: true, tension: 0.4, data: [], yAxisID: 'y', pointRadius: 2 },
                        { label: 'æ¿•åº¦', borderColor: '#22d3ee', backgroundColor: 'rgba(34,211,238,0.1)', fill: true, tension: 0.4, data: [], yAxisID: 'y1', pointRadius: 2 },
                        { label: 'åœŸå£¤', borderColor: '#4ade80', backgroundColor: 'rgba(74,222,128,0.1)', fill: true, tension: 0.4, data: [], yAxisID: 'y1', pointRadius: 2 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, animation: false,
                    plugins: { legend: { labels: { color: '#94a3b8', font: {size: 10} } } },
                    scales: { 
                        x: { ticks: { color: '#64748b' }, grid: { display: false } }, 
                        y: { 
                            type: 'linear', 
                            display: true, 
                            position: 'left', 
                            ticks: { color: '#f87171', stepSize: 0.1 }, 
                            grid: { color: '#334155' },
                            grace: 0.5 
                        },
                        y1: { 
                            type: 'linear', 
                            display: true, 
                            position: 'right', 
                            ticks: { color: '#e2e8f0' }, 
                            grid: { drawOnChartArea: false },
                            suggestedMin: 0,   
                            suggestedMax: 100  
                        }
                    }
                }
            });
        }

        function saveAndConnect() {
            const host = document.getElementById('mqttHost').value;
            let port = parseInt(document.getElementById('mqttPort')?.value) || 9001;
            const path = document.getElementById('mqttPath')?.value;
            const user = document.getElementById('mqttUser').value;
            const pass = document.getElementById('mqttPass').value;
            const proto = document.getElementById('mqttProto').value;
            const limit = document.getElementById('chartLimit').value; 

            // Basic sanity check for port
            if (port > 65535) port = 443; 

            localStorage.setItem('pi_host', host); localStorage.setItem('pi_port', port);
            localStorage.setItem('pi_path', path); localStorage.setItem('pi_user', user); 
            localStorage.setItem('pi_pass', pass); localStorage.setItem('pi_proto', proto);
            localStorage.setItem('pi_limit', limit); 
            
            // Update UI
            document.getElementById('chartLimitDisplay').innerText = limit;

            toggleSettings();
            connectMQTT();
        }

        function connectMQTT() {
            let host = localStorage.getItem('pi_host');
            if(!host && window.location.hostname) { host = window.location.hostname; document.getElementById('mqttHost').value = host; }
            if(!host) host = "mqtt.40312168.xyz"; 

            let port = parseInt(localStorage.getItem('pi_port'));
            if (!port) port = 443;

            const path = localStorage.getItem('pi_path') || '/mqtt';
            const user = localStorage.getItem('pi_user');
            const pass = localStorage.getItem('pi_pass');
            const proto = localStorage.getItem('pi_proto') || 'wss';
            
            // [Fix] Detect invalid port
            if (port > 65535) {
                log(`Port ${port} ç„¡æ•ˆï¼Œå·²é‡ç½®ç‚º 443`, "error");
                port = 443;
                localStorage.setItem('pi_port', 443);
                const portEl = document.getElementById('mqttPort');
                if(portEl) portEl.value = 443;
            }

            const useSSL = (proto === 'wss');
            const clientId = "WebClient_" + parseInt(Math.random() * 1000, 10);

            // HTTPS é˜»æ“‹æª¢æŸ¥
            if (window.location.protocol === 'https:' && !useSSL) {
                document.getElementById('httpsWarning').classList.remove('hidden');
                log("HTTPS é˜»æ“‹: ç„¡æ³•é€£ç·šè‡³ ws://", "error");
                updateConnStatus("Security Error", "text-red-500", false);
                return;
            }

            if (useSSL && (!user || !pass)) {
                log("âš ï¸ è­¦å‘Š: ä¼ºæœå™¨è¦æ±‚é©—è­‰ï¼Œè«‹è¼¸å…¥å¸³è™Ÿå¯†ç¢¼", "text-red-400");
                updateConnStatus("Auth Missing", "text-red-500", false);
                toggleSettings(); 
                return; 
            }

            updateConnStatus("Connecting...", "text-yellow-400", false);
            if(client) { try { client.disconnect(); } catch(e){} }

            try {
                client = new Paho.MQTT.Client(host, Number(port), path, clientId);
                client.onConnectionLost = onConnectionLost;
                client.onMessageArrived = onMessageArrived;

                const options = {
                    onSuccess: onConnect,
                    onFailure: onFailure,
                    useSSL: useSSL, 
                    timeout: 5
                };
                
                if(user) options.userName = user;
                if(pass) options.password = pass;

                client.connect(options);
                log(`å˜—è©¦é€£ç·š: ${proto}://${host}:${port}${path}`);
                if (useSSL) log("å·²å•Ÿç”¨ SSL å®‰å…¨é€£ç·š", "success");
            } catch (e) { log("Init Error: " + e.message, "error"); }
        }

        function onConnect() {
            updateConnStatus("å·²é€£ç·š", "text-green-400", true);
            log("é€£ç·šæˆåŠŸ (Connected)", "success");
            client.subscribe(topicSub);
        }

        function onFailure(e) {
            updateConnStatus("é€£ç·šå¤±æ•—", "text-red-500", false);
            let errorMsg = e.errorMessage;
            
            if (errorMsg.includes("AMQJS0007E") || errorMsg.includes("Socket error")) {
                const proto = document.getElementById('mqttProto').value;
                const port = document.getElementById('mqttPort')?.value;
                
                log(`[åš´é‡éŒ¯èª¤] ç„¡æ³•å»ºç«‹ WebSocket é€£ç·šã€‚`, "error");
                log(`éŒ¯èª¤ä»£ç¢¼: AMQJS0007E (Socket Error)`, "error");
                
                if (proto === 'wss' && port == '443') {
                     log(`æª¢æŸ¥å»ºè­°:`, "text-yellow-400");
                     log(`1. è«‹ç¢ºèªä¸»æ©Ÿåç¨±æ˜¯å¦æ­£ç¢º (ç›®å‰: ${document.getElementById('mqttHost').value})`, "text-slate-400");
                     log(`2. è‹¥ç„¡æ³•é€£ç·šï¼Œè«‹å˜—è©¦ Host æ”¹ç‚º 'mqtt.40312168.xyz'`, "text-slate-400");
                } else {
                     log(`è¨­å®šä¼¼ä¹ä¸æ­£ç¢ºã€‚è«‹ä½¿ç”¨ WSS + Port 443`, "error");
                }
            } else {
                log("é€£ç·šå¤±æ•—: " + e.errorMessage, "error");
            }
        }

        function onConnectionLost(e) {
            if (e.errorCode !== 0) {
                updateConnStatus("æ–·ç·š", "text-red-500", false);
                log("é€£ç·šä¸­æ–·: " + e.errorMessage, "error");
            }
        }

        function publishCmd(cmd) {
            if(!client || !client.isConnected()) { alert("å°šæœªé€£ç·šè‡³ MQTT Broker"); return; }
            const msg = new Paho.MQTT.Message(cmd);
            msg.destinationName = topicPub;
            client.send(msg);
            const statusDiv = document.getElementById('cmdStatus');
            statusDiv.innerText = `æŒ‡ä»¤ ${cmd} å·²ç™¼é€`;
            statusDiv.className = "text-xs text-center text-green-500 mt-4 h-4 font-mono";
            log(`ç™¼é€æŒ‡ä»¤: ${cmd}`, "success");
            setTimeout(() => { statusDiv.innerText = "System Ready"; statusDiv.className = "text-xs text-center text-slate-500 mt-4 h-4 font-mono"; }, 3000);
        }

        function onMessageArrived(msg) {
            const payload = msg.payloadString;
            document.getElementById('lastUpdate').innerText = new Date().toLocaleTimeString();
            try {
                const data = JSON.parse(payload);
                updateDashboard(data);
            } catch(e) { log("JSON Parse Error", "error"); }
        }

        function updateDashboard(data) {
            const t = data.temp; const h = data.hum; const s = data.soil; const status = data.status;
            
            // [Fix] Error Handling for -100 (Sensor Fail)
            const elTemp = document.getElementById('valTemp');
            if (t <= -100) {
                elTemp.innerText = "Err";
                elTemp.className = "text-4xl lg:text-5xl font-bold text-red-500 mb-1 tracking-tighter animate-pulse";
            } else {
                elTemp.innerText = t.toFixed(1);
                elTemp.className = "text-4xl lg:text-5xl font-bold text-white mb-1 tracking-tighter";
            }

            const elHum = document.getElementById('valHum');
            if (h <= -100) {
                elHum.innerText = "Err";
                elHum.className = "text-4xl lg:text-5xl font-bold text-red-500 mb-1 tracking-tighter animate-pulse";
            } else {
                elHum.innerText = h.toFixed(1);
                elHum.className = "text-4xl lg:text-5xl font-bold text-white mb-1 tracking-tighter";
            }

            document.getElementById('valSoil').innerText = s;
            document.getElementById('valSoil').className = "text-4xl lg:text-5xl font-bold text-white mb-1 tracking-tighter";
            
            const elSoil = document.getElementById('soilStatus');
            if (s < 20) { elSoil.innerText = "åš´é‡ç¼ºæ°´"; elSoil.className = "text-red-400 font-bold"; }
            else if (s > 80) { elSoil.innerText = "éæ¿•"; elSoil.className = "text-cyan-400 font-bold"; }
            else { elSoil.innerText = "é©ä¸­"; elSoil.className = "text-green-400 font-bold"; }

            const isPump = (status & 1) > 0;
            const isFert = (status & 2) > 0;
            const isLock = (status & 4) > 0;
            const isErr  = (status & 8) > 0;
            const isAuto = (status & 16) > 0;
            const isOlPump = (status & 32) > 0; 
            const isOlFert = (status & 64) > 0; 

            const modeInd = document.getElementById('modeInd'); const modeText = document.getElementById('modeText');
            if (isAuto) { modeInd.className = "w-3 h-3 rounded-full bg-green-500 shadow-[0_0_10px_#22c55e]"; modeText.innerText = "è‡ªå‹• (Auto)"; modeText.className = "text-[10px] text-green-400 font-bold"; } 
            else { modeInd.className = "w-3 h-3 rounded-full bg-orange-500 shadow-[0_0_10px_#f97316]"; modeText.innerText = "æ‰‹å‹• (Manual)"; modeText.className = "text-[10px] text-orange-400 font-bold"; }

            const sensTxt = document.getElementById('sensorText');
            if (isErr) { sensTxt.innerText = "ç•°å¸¸"; sensTxt.className = "text-xs font-bold text-white bg-red-600 px-2 py-1 rounded animate-pulse"; } 
            else { sensTxt.innerText = "æ­£å¸¸"; sensTxt.className = "text-xs font-bold text-green-500 bg-green-500/10 px-2 py-1 rounded"; }

            const pumpInd = document.getElementById('pumpInd'); const pumpTxt = document.getElementById('pumpStatusText');
            if (isOlPump) { pumpInd.className = "w-3 h-3 rounded-full bg-red-600 animate-pulse-red"; pumpTxt.innerText = "éè¼‰è·³è„« (Trip)"; pumpTxt.className = "text-[10px] text-red-500 font-bold animate-pulse"; } 
            else if (isLock) { pumpInd.className = "w-3 h-3 rounded-full bg-red-600 animate-pulse-red"; pumpTxt.innerText = "è¶…æ™‚é–å®š"; pumpTxt.className = "text-[10px] text-red-500"; } 
            else if (isPump) { pumpInd.className = "w-3 h-3 rounded-full bg-blue-500 shadow-[0_0_10px_#3b82f6] animate-pulse"; pumpTxt.innerText = "é‹è½‰ä¸­"; pumpTxt.className = "text-[10px] text-blue-400 font-bold"; } 
            else { pumpInd.className = "w-3 h-3 rounded-full bg-slate-600"; pumpTxt.innerText = "å¾…æ©Ÿ"; pumpTxt.className = "text-[10px] text-slate-500"; }

            const fertInd = document.getElementById('fertInd'); const fertTxt = document.getElementById('fertStatusText');
            if (isOlFert) { fertInd.className = "w-3 h-3 rounded-full bg-red-600 animate-pulse-red"; fertTxt.innerText = "éè¼‰è·³è„« (Trip)"; fertTxt.className = "text-[10px] text-red-500 font-bold animate-pulse"; } 
            else if (isFert) { fertInd.className = "w-3 h-3 rounded-full bg-yellow-500 shadow-[0_0_10px_#eab308] animate-pulse"; fertTxt.innerText = "é‹è½‰ä¸­"; fertTxt.className = "text-[10px] text-yellow-400 font-bold"; } 
            else { fertInd.className = "w-3 h-3 rounded-full bg-slate-600"; fertTxt.innerText = "å®šæ™‚å¾…æ©Ÿ"; fertTxt.className = "text-[10px] text-slate-500"; }

            if(chart) {
                const limit = parseInt(localStorage.getItem('pi_limit')) || 30; // [New] Get limit
                
                const timeLabel = new Date().toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit', second:'2-digit'});
                if(chart.data.labels.length > limit) {
                    chart.data.labels.shift();
                    chart.data.datasets[0].data.shift();
                    chart.data.datasets[1].data.shift();
                    chart.data.datasets[2].data.shift();
                }
                chart.data.labels.push(timeLabel);
                
                // Chart: Don't plot -100, plot null to break the line or 0
                chart.data.datasets[0].data.push(t <= -100 ? null : t);
                chart.data.datasets[1].data.push(h <= -100 ? null : h);
                chart.data.datasets[2].data.push(s);
                chart.update('none');
            }
        }

        function updateConnStatus(msg, colorClass, isOk) {
            document.getElementById('connText').innerText = msg;
            document.getElementById('connText').className = `text-[10px] font-bold ${colorClass}`;
            document.getElementById('connDot').className = `w-2 h-2 rounded-full ${isOk ? 'bg-green-500 shadow-[0_0_5px_#22c55e]' : 'bg-red-500'}`;
        }

        // [Updated] Clock with Date
        function updateClock() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-GB', { hour12: false });
            const dateStr = now.toLocaleDateString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit' });
            document.getElementById('digitalClock').innerText = timeStr;
            document.getElementById('digitalDate').innerText = dateStr;
        }

        window.onload = function() {
            updateClock();
            setInterval(updateClock, 1000);
            
            if(localStorage.getItem('pi_host')) {
                document.getElementById('mqttHost').value = localStorage.getItem('pi_host');
                
                const portEl = document.getElementById('mqttPort');
                if(portEl) portEl.value = localStorage.getItem('pi_port');
                
                const pathEl = document.getElementById('mqttPath');
                if(pathEl) pathEl.value = localStorage.getItem('pi_path') || '/mqtt';
                
                document.getElementById('mqttUser').value = localStorage.getItem('pi_user') || '';
                document.getElementById('mqttPass').value = localStorage.getItem('pi_pass') || '';
                document.getElementById('mqttProto').value = localStorage.getItem('pi_proto') || 'wss'; 

                // [New] Load limit
                const savedLimit = localStorage.getItem('pi_limit') || '30';
                document.getElementById('chartLimit').value = savedLimit;
                document.getElementById('chartLimitDisplay').innerText = savedLimit;

            } else {
                localStorage.setItem('pi_proto', 'wss');
                localStorage.setItem('pi_port', 443);
                localStorage.setItem('pi_host', 'mqtt.40312168.xyz');
                
                document.getElementById('mqttProto').value = 'wss';
                const portEl = document.getElementById('mqttPort');
                if(portEl) portEl.value = 443;
                document.getElementById('mqttHost').value = 'mqtt.40312168.xyz';
            }
            initChart();
            connectMQTT(); 
        }
    </script>
</body>
</html>
