<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 智慧農場中控台</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- 引入 Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-slate-900 text-slate-200 font-sans min-h-screen">

    <!-- 導覽列 -->
    <nav class="bg-slate-800 p-4 border-b border-slate-700 sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center">
                <i class="fa-solid fa-leaf text-green-500 mr-2 text-xl"></i>
                <h1 class="text-lg md:text-xl font-bold text-white hidden md:block" data-i18n="navTitle">Smart Farm Auto</h1>
                <h1 class="text-lg font-bold text-white md:hidden">Farm</h1>
            </div>

            <!-- 時鐘 -->
            <div class="flex items-center gap-2 bg-slate-900 px-4 py-1 rounded-full border border-slate-700 shadow-inner">
                <i class="fa-regular fa-clock text-slate-400 text-sm"></i>
                <span id="digitalClock" class="font-mono text-green-400 font-bold tracking-widest">--:--:--</span>
            </div>

            <!-- 右側按鈕 -->
            <div class="flex gap-2 items-center">
                <button onclick="toggleLanguage()" class="text-slate-300 hover:text-white px-2 py-1 font-bold text-sm border border-slate-600 rounded hover:bg-slate-700 transition mr-1">
                    <i class="fa-solid fa-globe mr-1"></i><span id="langBtnText">EN</span>
                </button>
                <button onclick="exportCSV()" class="bg-blue-600 hover:bg-blue-500 text-white px-3 py-1 rounded text-sm font-bold shadow transition">
                    <i class="fa-solid fa-download mr-1"></i> <span data-i18n="exportBtn">匯出</span>
                </button>
                <button onclick="toggleSetup()" class="text-slate-400 hover:text-white p-2">
                    <i class="fa-solid fa-gear text-lg"></i>
                </button>
            </div>
        </div>
    </nav>

    <main class="container mx-auto p-4 max-w-6xl">
        
        <!-- 設定面板 (預設隱藏) -->
        <div id="setupPanel" class="bg-slate-800 p-6 rounded-lg mb-6 border border-green-500/50 shadow-lg hidden">
            <h3 class="font-bold mb-4 text-green-300" data-i18n="setupTitle">系統設定</h3>
            <div class="grid gap-4 md:grid-cols-2">
                <div><label class="block text-xs text-slate-400 mb-1">Channel ID</label><input type="text" id="channelId" class="w-full bg-slate-900 border border-slate-600 rounded p-2"></div>
                <div><label class="block text-xs text-slate-400 mb-1">Read API Key</label><input type="text" id="readKey" class="w-full bg-slate-900 border border-slate-600 rounded p-2"></div>
                <div><label class="block text-xs text-slate-400 mb-1">TalkBack ID</label><input type="text" id="tbId" class="w-full bg-slate-900 border border-slate-600 rounded p-2"></div>
                <div><label class="block text-xs text-slate-400 mb-1">TalkBack API Key</label><input type="text" id="tbKey" class="w-full bg-slate-900 border border-slate-600 rounded p-2"></div>
            </div>
            <button onclick="saveSettings()" class="mt-4 bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded font-bold w-full transition" data-i18n="saveBtn">儲存設定</button>
        </div>

        <!-- 紅色警報橫幅 (自動顯示) -->
        <div id="alertBanner" class="hidden mb-6 bg-red-600 text-white p-4 rounded-lg text-center animate-pulse font-bold text-lg shadow-[0_0_15px_rgba(239,68,68,0.7)]">
            <i class="fa-solid fa-triangle-exclamation mr-2"></i> <span data-i18n="alertMsg">警報：水泵運轉超時，系統已強制鎖定！</span>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            
            <!-- 左側：環境數據 -->
            <div class="lg:col-span-2 bg-slate-800 p-6 rounded-lg border border-slate-700 flex flex-col justify-between">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-slate-400 text-sm uppercase font-bold" data-i18n="monitorTitle">環境監測</h3>
                    <span class="text-xs text-slate-500"><span data-i18n="updated">更新:</span> <span id="lastUpdate" class="text-white">--</span></span>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- 溫度 -->
                    <div id="cardTemp" class="bg-slate-700/50 p-4 rounded-lg text-center border border-transparent transition-all duration-500">
                        <i class="fa-solid fa-temperature-half text-2xl text-red-400 mb-2"></i>
                        <div class="text-4xl font-bold text-white mb-1" id="tempVal">--</div>
                        <div class="text-xs text-slate-400"><span data-i18n="temp">溫度</span> °C</div>
                    </div>
                    <!-- 濕度 -->
                    <div id="cardHum" class="bg-slate-700/50 p-4 rounded-lg text-center border border-transparent transition-all duration-500">
                        <i class="fa-solid fa-droplet text-2xl text-cyan-400 mb-2"></i>
                        <div class="text-4xl font-bold text-white mb-1" id="humVal">--</div>
                        <div class="text-xs text-slate-400"><span data-i18n="hum">濕度</span> %</div>
                    </div>
                    <!-- 土壤 -->
                    <div id="cardSoil" class="bg-slate-700/50 p-4 rounded-lg text-center border border-transparent transition-all duration-500">
                        <i class="fa-solid fa-seedling text-2xl text-green-400 mb-2"></i>
                        <div class="text-4xl font-bold text-white mb-1" id="soilVal">--</div>
                        <div class="text-xs text-slate-400"><span data-i18n="soil">土壤</span> %</div>
                        <div class="mt-2 text-xs text-slate-500 bg-slate-900/50 rounded py-1">
                            <span data-i18n="status">狀態</span>: <span id="soilStatus" class="text-slate-300">--</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 右側：控制與狀態 -->
            <div class="bg-slate-800 p-6 rounded-lg border border-slate-700 flex flex-col">
                <h3 class="text-slate-400 text-sm uppercase font-bold mb-6" data-i18n="controlTitle">自動化運作狀態</h3>
                
                <div class="space-y-4 flex-grow">
                    <!-- 水泵 -->
                    <div class="bg-slate-900 p-4 rounded border border-slate-700 flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div id="pumpInd" class="w-4 h-4 rounded-full bg-slate-600 transition-colors duration-500"></div>
                            <div>
                                <div class="text-sm font-bold text-blue-200" data-i18n="pump">水泵 (Water Pump)</div>
                                <div class="text-[10px] text-slate-500" data-i18n="autoControl">自動控制 / Manual</div>
                            </div>
                        </div>
                        <div class="flex gap-1">
                            <button onclick="sendCommand('LED1_ON', 1)" class="bg-blue-600 hover:bg-blue-500 text-white px-2 py-1 rounded text-xs">ON</button>
                            <button onclick="sendCommand('LED1_OFF', 1)" class="bg-slate-600 hover:bg-slate-500 text-white px-2 py-1 rounded text-xs">OFF</button>
                        </div>
                    </div>
                    <!-- 狀態文字顯示 -->
                    <div id="pumpText" class="text-xs text-right text-slate-500 font-bold mb-2">Idle</div>

                    <!-- 施肥 -->
                    <div class="bg-slate-900 p-4 rounded border border-slate-700 flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div id="fertInd" class="w-4 h-4 rounded-full bg-slate-600 transition-colors duration-500"></div>
                            <div>
                                <div class="text-sm font-bold text-yellow-200" data-i18n="fert">施肥 (Fertilizer)</div>
                                <div class="text-[10px] text-slate-500" data-i18n="fertTime">每日 08:00 (10分鐘)</div>
                            </div>
                        </div>
                        <div class="flex gap-1">
                            <button onclick="sendCommand('LED2_ON', 2)" class="bg-yellow-600 hover:bg-yellow-500 text-white px-2 py-1 rounded text-xs">ON</button>
                            <button onclick="sendCommand('LED2_OFF', 2)" class="bg-slate-600 hover:bg-slate-500 text-white px-2 py-1 rounded text-xs">OFF</button>
                        </div>
                    </div>
                    <!-- 狀態文字顯示 -->
                    <div id="fertText" class="text-xs text-right text-slate-500 font-bold">Idle</div>
                </div>
                
                <div id="cmdStatus" class="text-xs text-center text-slate-500 mt-4 h-4 font-mono">System Ready</div>
            </div>
        </div>

        <!-- 圖表區 -->
        <div class="bg-slate-800 p-4 rounded-lg border border-slate-700 h-80 relative">
            <h3 class="text-slate-400 text-sm uppercase font-bold mb-2" data-i18n="chartTitle">趨勢分析</h3>
            <div class="w-full h-full pb-6">
                <canvas id="historyChart"></canvas>
            </div>
        </div>

    </main>

    <script>
        let intervalId;
        let myChart;
        let currentFeeds = [];
        let curLang = 'zh';
        let statusTimeout;

        // --- 多語言設定 ---
        const i18n = {
            zh: {
                navTitle: "智慧農場監控系統",
                exportBtn: "匯出",
                setupTitle: "連線設定",
                saveBtn: "儲存並連線",
                alertMsg: "警報：水泵運轉超時，系統已強制鎖定！(請手動重啟 ESP32)",
                monitorTitle: "環境監控",
                updated: "更新:",
                temp: "溫度",
                hum: "濕度",
                soil: "土壤",
                status: "狀態",
                statusDry: "缺水",
                statusWet: "過濕",
                statusOk: "適中",
                controlTitle: "自動化運作狀態",
                pump: "水泵 (自動補水)",
                fert: "施肥機 (定時)",
                autoControl: "自動控制 / 手動介入",
                fertTime: "每日 08:00 (10分鐘)",
                chartTitle: "趨勢分析 (最近20筆)",
                statusIdle: "待命",
                statusRun: "運轉中",
                statusLock: "已鎖定",
                cmdSent: "指令已發送",
                cmdFail: "發送失敗",
                exportError: "無數據可匯出"
            },
            en: {
                navTitle: "Smart Farm System",
                exportBtn: "Export",
                setupTitle: "Connection Setup",
                saveBtn: "Save & Connect",
                alertMsg: "ALERT: Pump timeout! System locked. (Reset ESP32 required)",
                monitorTitle: "Environment Monitor",
                updated: "Updated:",
                temp: "Temp",
                hum: "Humidity",
                soil: "Soil",
                status: "Status",
                statusDry: "Dry",
                statusWet: "Wet",
                statusOk: "Good",
                controlTitle: "Automation Status",
                pump: "Water Pump (Auto)",
                fert: "Fertilizer (Timer)",
                autoControl: "Auto / Manual Override",
                fertTime: "Daily 08:00 (10 mins)",
                chartTitle: "Trend Analysis (Last 20)",
                statusIdle: "Idle",
                statusRun: "Running",
                statusLock: "LOCKED",
                cmdSent: "Command Sent",
                cmdFail: "Failed",
                exportError: "No data"
            }
        };

        // --- 時鐘 ---
        setInterval(() => document.getElementById('digitalClock').innerText = new Date().toLocaleTimeString('en-GB', { hour12: false }), 1000);

        // --- 語言切換 ---
        function toggleLanguage() {
            curLang = curLang === 'zh' ? 'en' : 'zh';
            document.getElementById('langBtnText').innerText = curLang === 'zh' ? 'EN' : '中';
            updateInterfaceText();
        }

        function updateInterfaceText() {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (i18n[curLang][key]) el.innerText = i18n[curLang][key];
            });
            // 更新圖表標籤
            myChart.data.datasets[0].label = i18n[curLang].temp;
            myChart.data.datasets[1].label = i18n[curLang].hum;
            myChart.data.datasets[2].label = i18n[curLang].soil;
            myChart.update();
            // 更新目前狀態文字 (如果有數據)
            if(currentFeeds.length > 0) {
                const last = currentFeeds[currentFeeds.length-1];
                updateStatusDisplay(parseInt(last.field4) || 0);
                updateSoilStatusText(parseFloat(last.field3));
            }
        }

        function updateSoilStatusText(s) {
            const el = document.getElementById('soilStatus');
            if(isNaN(s)) return;
            el.innerText = s < 20 ? i18n[curLang].statusDry : (s > 80 ? i18n[curLang].statusWet : i18n[curLang].statusOk);
        }

        // --- 初始化 Chart.js ---
        const ctx = document.getElementById('historyChart').getContext('2d');
        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    { label: '溫度', borderColor: '#f87171', backgroundColor: 'rgba(248,113,113,0.1)', fill: true, tension: 0.4, spanGaps: true, yAxisID: 'y' },
                    { label: '濕度', borderColor: '#22d3ee', backgroundColor: 'rgba(34,211,238,0.1)', fill: true, tension: 0.4, spanGaps: true, yAxisID: 'y1' },
                    { label: '土壤', borderColor: '#4ade80', backgroundColor: 'rgba(74,222,128,0.1)', fill: true, tension: 0.4, spanGaps: true, yAxisID: 'y1' }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: { legend: { labels: { color: '#94a3b8' } } },
                scales: {
                    x: { ticks: { color: '#64748b' }, grid: { display: false } },
                    y: { type: 'linear', display: true, position: 'left', ticks: { color: '#f87171' }, grid: { color: '#334155' } },
                    y1: { type: 'linear', display: true, position: 'right', ticks: { color: '#e2e8f0' }, grid: { drawOnChartArea: false } }
                }
            }
        });

        function toggleSetup() { document.getElementById('setupPanel').classList.toggle('hidden'); }

        function saveSettings() {
            const ids = ['channelId', 'readKey', 'tbId', 'tbKey'];
            const vals = ids.map(id => document.getElementById(id).value);
            if(!vals[0] || !vals[2] || !vals[3]) return alert("Please fill in fields");
            ids.forEach((id, i) => localStorage.setItem('conf_'+id, vals[i]));
            document.getElementById('setupPanel').classList.add('hidden');
            startLoop();
        }

        // --- 核心：讀取數據與狀態 ---
        async function fetchSensorData() {
            const cid = localStorage.getItem('conf_channelId');
            const rkey = localStorage.getItem('conf_readKey');
            if(!cid) return;

            try {
                let url = `https://api.thingspeak.com/channels/${cid}/feeds.json?results=20`;
                if(rkey) url += `&api_key=${rkey}`;

                const res = await fetch(url);
                const data = await res.json();
                const feeds = data.feeds;
                currentFeeds = feeds;

                if(feeds.length > 0) {
                    const last = feeds[feeds.length-1];
                    const t = parseFloat(last.field1);
                    const h = parseFloat(last.field2);
                    const s = parseFloat(last.field3);
                    const status = parseInt(last.field4) || 0; // 讀取 Field 4 狀態碼

                    // 更新數值
                    document.getElementById('tempVal').innerText = t.toFixed(1);
                    document.getElementById('humVal').innerText = h.toFixed(1);
                    document.getElementById('soilVal').innerText = s.toFixed(0);
                    document.getElementById('lastUpdate').innerText = new Date(last.created_at).toLocaleTimeString();

                    // 更新視覺警告
                    updateCard('temp', t, 30, 'high');
                    updateCard('soil', s, 20, 'low');
                    
                    // 更新土壤文字
                    updateSoilStatusText(s);
                    document.getElementById('soilStatus').className = s < 20 ? "text-red-400 font-bold" : "text-slate-300";

                    // 更新自動化狀態顯示
                    updateStatusDisplay(status);

                    // 更新圖表
                    myChart.data.labels = feeds.map(f => new Date(f.created_at).toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'}));
                    myChart.data.datasets[0].data = feeds.map(f => f.field1);
                    myChart.data.datasets[1].data = feeds.map(f => f.field2);
                    myChart.data.datasets[2].data = feeds.map(f => f.field3);
                    myChart.update();
                }
            } catch(e) { console.error(e); }
        }

        // --- 更新狀態燈號 (根據 ESP32 回傳的 field4) ---
        function updateStatusDisplay(code) {
            const pumpInd = document.getElementById('pumpInd');
            const fertInd = document.getElementById('fertInd');
            const pumpTxt = document.getElementById('pumpText');
            const fertTxt = document.getElementById('fertText');
            const banner = document.getElementById('alertBanner');

            // 重置
            banner.classList.add('hidden');
            pumpInd.className = "w-4 h-4 rounded-full bg-slate-600";
            fertInd.className = "w-4 h-4 rounded-full bg-slate-600";
            pumpTxt.innerText = i18n[curLang].statusIdle;
            fertTxt.innerText = i18n[curLang].statusIdle;
            pumpTxt.className = "text-xs text-right text-slate-500 font-bold mb-2";
            fertTxt.className = "text-xs text-right text-slate-500 font-bold";

            if (code === 1) { // 澆水中
                pumpInd.className = "w-4 h-4 rounded-full bg-blue-500 shadow-[0_0_10px_#3b82f6] animate-pulse";
                pumpTxt.innerText = i18n[curLang].statusRun;
                pumpTxt.className = "text-xs text-right font-bold text-blue-400 mb-2";
            } else if (code === 2) { // 施肥中
                fertInd.className = "w-4 h-4 rounded-full bg-yellow-500 shadow-[0_0_10px_#eab308] animate-pulse";
                fertTxt.innerText = i18n[curLang].statusRun;
                fertTxt.className = "text-xs text-right font-bold text-yellow-400";
            } else if (code === 9) { // 警報
                banner.classList.remove('hidden');
                pumpInd.className = "w-4 h-4 rounded-full bg-red-600";
                pumpTxt.innerText = i18n[curLang].statusLock;
                pumpTxt.className = "text-xs text-right font-bold text-red-500 mb-2";
            }
        }

        function updateCard(type, val, threshold, mode) {
            const elCard = document.getElementById('card'+type.charAt(0).toUpperCase() + type.slice(1));
            let isAlert = (mode === 'high' && val > threshold) || (mode === 'low' && val < threshold);
            elCard.className = isAlert ? "bg-red-900/40 p-4 rounded-lg text-center border border-red-500 animate-pulse transition-all duration-500" : "bg-slate-700/50 p-4 rounded-lg text-center border border-transparent transition-all duration-500";
        }

        async function sendCommand(cmd, ledNum) {
            const tbid = localStorage.getItem('conf_tbId');
            const tbk = localStorage.getItem('conf_tbKey');
            const statusDiv = document.getElementById('cmdStatus');
            
            if(!tbid || !tbk) return alert("Please setup TalkBack first");
            if(statusTimeout) clearTimeout(statusTimeout);

            statusDiv.innerText = i18n[curLang].cmdSending;
            statusDiv.className = "text-xs text-center text-yellow-500 mt-4 h-4 font-mono";

            const formData = new FormData();
            formData.append('api_key', tbk);
            formData.append('command_string', cmd);

            try {
                const res = await fetch(`https://api.thingspeak.com/talkbacks/${tbid}/commands`, { method: 'POST', body: formData });
                if(res.ok) {
                    statusDiv.innerText = i18n[curLang].cmdSent;
                    statusDiv.className = "text-xs text-center text-green-500 mt-4 h-4 font-mono";
                    statusTimeout = setTimeout(() => {
                        statusDiv.innerText = "System Ready";
                        statusDiv.className = "text-xs text-center text-slate-500 mt-4 h-4 font-mono";
                    }, 5000);
                }
            } catch (e) { 
                statusDiv.innerText = i18n[curLang].cmdFail;
                statusDiv.className = "text-xs text-center text-red-500 mt-4 h-4 font-mono";
            }
        }

        function exportCSV() {
            if(currentFeeds.length === 0) return alert(i18n[curLang].exportError);
            let csv = "data:text/csv;charset=utf-8,Time,Temp,Humidity,Soil,Status\n";
            currentFeeds.forEach(row => {
                const t = new Date(row.created_at).toLocaleString();
                csv += `${t},${row.field1},${row.field2},${row.field3},${row.field4}\n`;
            });
            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csv));
            link.setAttribute("download", "farm_data.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function startLoop() {
            fetchSensorData();
            if(intervalId) clearInterval(intervalId);
            intervalId = setInterval(fetchSensorData, 15000);
        }

        window.onload = () => {
            const ids = ['channelId', 'readKey', 'tbId', 'tbKey'];
            ids.forEach(id => {
                const val = localStorage.getItem('conf_'+id);
                if(val) document.getElementById(id).value = val;
            });
            if(localStorage.getItem('conf_channelId')) {
                startLoop();
            } else {
                document.getElementById('setupPanel').classList.remove('hidden');
            }
        };
    </script>
</body>
</html>